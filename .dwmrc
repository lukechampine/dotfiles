# Separators
lightdark () {
    echo -ne "\x0E\xC2\xB9\x02"
}
darklight () {
    echo -ne "\x07\xC2\xB9\x09"
}

# Widget functions
wifi () {
    STATUS="X`/sbin/iwgetid`"
    if test "$STATUS" != "X" ; then
        ESSID="`/sbin/iwgetid |awk -F ":" '{print $2}'|sed -e 's/"//g'`"
        QUALITY="`wicd-cli -d --wireless | awk '/Quality:/ {print $2}'`"
        echo -ne "\xC2\xAC $QUALITY $ESSID"
    else
        echo -ne "\xC2\xAC Not Connected"
    fi
} 

batt () {
    PRESENT=`cat /sys/class/power_supply/BAT0/present`
    STATUS=`cat /sys/class/power_supply/BAT0/status`
    if [ "$PRESENT" != "0" ]; then
        CHARGE=`cat /sys/class/power_supply/BAT0/capacity`
        if [ $CHARGE -eq 100 ]; then
            LEVEL="\xC2\xA6 ${CHARGE}"
        elif [ $CHARGE -ge 80 ]; then
            LEVEL="\xC2\xAB ${CHARGE}"
        elif [ $CHARGE -ge 60 ]; then
            LEVEL="\xC2\xAA ${CHARGE}"
        elif [ $CHARGE -ge 40 ]; then
            LEVEL="\xC2\xA9 ${CHARGE}"
        elif [ $CHARGE -ge 20 ]; then
            LEVEL="\xC2\xA8 ${CHARGE}"
        else
            LEVEL="\xC2\xA7 ${CHARGE}"
        fi
        case $STATUS in
            Full)
                SIGN="=";;
            Charging)
                SIGN="+";;
            Discharging)
                SIGN="-";;
            Unknown)
                SIGN="+";;
        esac
        # blink while charging
        if [ $SIGN = "+" ] && [ $BLINK = "true" ]; then
            LEVEL="\xC2\xA6 ${CHARGE}"
        fi
        echo -ne "$LEVEL${SIGN}"
    else
        echo "\xC2\xA6 AC"
    fi
}

cpu() {
      CPU="$(eval $(awk '/^cpu /{print "previdle=" $5 "; prevtotal=" $2+$3+$4+$5 }' /proc/stat); sleep 0.4; 
      eval $(awk '/^cpu /{print "idle=" $5 "; total=" $2+$3+$4+$5 }' /proc/stat); 
      intervaltotal=$((total-${prevtotal:-0})); 
      echo "$((100*( (intervaltotal) - ($idle-${previdle:-0}) ) / (intervaltotal) ))")"
      echo -ne "\xC2\xA5 $CPU%"
}

mem () {
    MEM="`free -m | awk 'NR==3 { print $3 }'`"
    echo -ne "\xC2\xA4 $MEM MB"
}

cputemp () {
    TEMP="`sensors | awk 'NR==3 {print substr($2,2,4)}'`"
    echo -ne "\xC3\x81 $TEMP\xC2\xBAC"
}

fanspeed () {
    SPEED="`cat /sys/bus/platform/devices/thinkpad_hwmon/fan1_input`"
    echo -ne "\xC3\x80 $SPEED RPM"
}

datetime () {
    echo -e "\xC2\xAE `date '+%I:%M %p'`"
}

colortest () {
    echo -ne "\x01\xC2\xB9\x06x06\x07x07 \x06\xC2\xB9\x01x01\x02x02 \x01\xC2\xB9\x08x08\x09x09 \x06\xC2\xB9\x03x03\x04x04"
}

# boolean variable, flipped every update to allow for blinking
BLINK=true
invert () {
    if [ $BLINK = "true" ]; then
        BLINK=false 
    else
        BLINK=true
    fi
}

# Send widget text to xsetroot, update every two seconds
while true; do
    invert;
    xsetroot -name "`darklight``cpu` `lightdark``mem` `darklight``cputemp` `lightdark``fanspeed` `darklight``batt` `lightdark``wifi` `darklight``datetime`"
    sleep 2
done
